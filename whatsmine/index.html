<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>whats mine. | v1.3.4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        :root {
            --bg: #000000;
            --panel: #111111;
            --border: rgba(255, 255, 255, 0.1);
            --accent: #ffffff;
            --text-main: #efefef;
            --text-dim: #777;
            --success: #00ff88;
            --danger: #ff453a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100dvh;
            /* Extra bottom padding to clear iOS Safari UI */
            padding: env(safe-area-inset-top) 15px calc(env(safe-area-inset-bottom) + 100px) 15px;
        }

        .app-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }

        header { 
            padding: 20px 0 10px 0; 
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        h1 { font-size: 1.5rem; font-weight: 800; letter-spacing: -1px; margin: 0; }
        .version { font-family: monospace; font-size: 0.6rem; color: var(--text-dim); }

        .card { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            width: 100%;
        }

        .section-label { 
            font-size: 0.65rem; 
            font-weight: 700; 
            color: var(--text-dim); 
            text-transform: uppercase; 
            margin-bottom: 15px; 
            display: block; 
            letter-spacing: 1px;
        }

        input, textarea { 
            width: 100%; 
            background: #1a1a1a; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 14px; 
            color: white; 
            font-size: 16px; /* Critical: Stops iOS auto-zoom on focus */
            margin-bottom: 12px; 
            outline: none;
        }

        .btn { 
            width: 100%; 
            padding: 16px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 700; 
            font-size: 1rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px;
        }
        .btn-primary { background: white; color: black; }
        .btn-secondary { background: rgba(255,255,255,0.05); color: white; margin-top: 10px; }

        .vault-item { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            margin-bottom: 15px; 
            overflow: hidden;
        }
        
        .item-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: 700; font-size: 1.1rem; }
        .item-img { width: 100%; display: block; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        
        .qr-strip { padding: 15px 20px; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.02); }
        .qr-code-box { background: white; padding: 4px; border-radius: 6px; flex-shrink: 0; }
        .qr-code-box canvas { width: 70px !important; height: 70px !important; }

        /* Full Screen Modals for iOS */
        #detail-view, #save-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; 
            background: black; z-index: 9999; display: none; 
            flex-direction: column; padding: env(safe-area-inset-top) 20px;
            overflow-y: auto;
        }

        #final-label-img { width: 100%; border-radius: 8px; margin: 20px 0; border: 1px solid white; }

        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: black; z-index: 10000; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="save-modal">
    <div style="text-align:center; padding: 20px 0;">
        <span class="section-label" style="color:white;">Label Ready</span>
        <p style="font-size: 0.8rem; opacity: 0.7;">Long-press to save to Photos</p>
    </div>
    <img id="final-label-img">
    <button class="btn btn-secondary" onclick="document.getElementById('save-modal').style.display='none'">Dismiss</button>
</div>

<div id="detail-view">
    <div id="detail-content" style="margin-top: 40px;"></div>
</div>

<div id="scanner-overlay">
    <video id="video-preview" playsinline></video>
    <button class="btn btn-secondary" style="position:absolute; bottom:40px; width:80%; left:10%;" onclick="stopScanner()">Exit Scanner</button>
</div>

<div class="app-container">
    <header>
        <div>
            <h1 onclick="location.reload()">whats mine.</h1>
            <div class="version">CORE_SYSTEM_v1.3.4</div>
        </div>
        <div style="color:var(--success); font-size:0.6rem; font-weight:800; letter-spacing:1px;">ONLINE</div>
    </header>

    <div class="card">
        <span class="section-label">Create Asset Record</span>
        <input type="text" id="itemName" placeholder="Object Name (e.g. Charging Brick)">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" id="uploadBtn">Add Photo</button>
        <img id="imagePreview" style="width:100%; border-radius:12px; margin: 10px 0; display:none;">
        <textarea id="itemDesc" rows="2" placeholder="Notes/Serial Number..."></textarea>
        <button class="btn btn-primary" id="saveItemBtn">Commit to Vault</button>
        <button class="btn btn-secondary" onclick="startScanner()" style="border: 1px solid var(--success); color: var(--success);">Open Scanner</button>
    </div>

    <div id="vaultList">
        <span class="section-label">Active Vault Feed</span>
        </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const IMGBB_API_KEY = "d930d102762e2539450d6d7afceb9811";
    const firebaseConfig = {
        apiKey: "AIzaSyDn3fqrdVcRnvkiX7t6TPJWrngXSrM_1p4",
        authDomain: "my-a-ab8f3.firebaseapp.com",
        projectId: "my-a-ab8f3",
        storageBucket: "my-a-ab8f3.firebasestorage.app",
        messagingSenderId: "65984042323",
        appId: "1:65984042323:web:f4a5463bd4cc220d2c3da6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const inventoryCol = collection(db, "inventory");
    const BASE_URL = "https://lsp-code.github.io/lw/whatsmine/";

    // Deep Link Check
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('id')) {
        const id = urlParams.get('id');
        const snap = await getDoc(doc(db, "inventory", id));
        if (snap.exists()) {
            const d = snap.data();
            document.getElementById('detail-content').innerHTML = `
                <div class="card" style="border-color:var(--success);">
                    <span class="section-label">Identity Verified</span>
                    <h2 style="margin: 5px 0 20px 0;">LOGAN WESTLAKE</h2>
                    <p style="color:var(--text-dim); margin:0;">ASSET</p>
                    <h3 style="margin:0 0 15px 0;">${d.name}</h3>
                    ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%; border-radius:12px; margin-bottom:15px;">` : ''}
                    <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; font-size:0.9rem; margin-bottom:20px;">${d.desc || 'No notes found.'}</div>
                    <button class="btn btn-primary" onclick="location.href='${BASE_URL}'">Enter My Vault</button>
                </div>
            `;
            document.getElementById('detail-view').style.display = 'flex';
        }
    }

    // Upload & Save
    document.getElementById('fileInput').onchange = e => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('imagePreview').src = URL.createObjectURL(file);
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('uploadBtn').innerText = "Change Photo";
        }
    };

    document.getElementById('saveItemBtn').onclick = async () => {
        const name = document.getElementById('itemName').value;
        const desc = document.getElementById('itemDesc').value;
        const file = document.getElementById('fileInput').files[0];
        const btn = document.getElementById('saveItemBtn');
        if(!name) return alert("Missing Item Name");
        
        btn.disabled = true; btn.innerText = "Uploading...";
        let imageUrl = "";
        if (file) {
            const fd = new FormData(); fd.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:"POST", body:fd});
            imageUrl = (await res.json()).data.url;
        }
        await addDoc(inventoryCol, {name, desc, imageUrl, timestamp: Date.now()});
        location.reload();
    };

    // Live Feed
    onSnapshot(query(inventoryCol, orderBy("timestamp", "desc")), snap => {
        const list = document.getElementById('vaultList');
        list.innerHTML = '<span class="section-label">Active Vault Feed</span>';
        snap.forEach(doc => {
            const d = doc.data();
            const id = doc.id;
            const item = document.createElement('div');
            item.className = 'vault-item';
            item.innerHTML = `
                <div class="item-header">
                    <span class="item-name">${d.name}</span>
                    <span onclick="deleteItem('${id}')" style="color:var(--danger); font-size:0.7rem; font-weight:800;">EXPUNGE</span>
                </div>
                ${d.imageUrl ? `<img src="${d.imageUrl}" class="item-img">` : ''}
                <div class="qr-strip" onclick="generateHDTag('${id}', '${d.name}')">
                    <div class="qr-code-box" id="qr-${id}"></div>
                    <div>
                        <b style="display:block; font-size:0.75rem;">LOGAN WESTLAKE</b>
                        <span style="font-size:0.6rem; opacity:0.5;">TAP FOR PRINTABLE HD TAG</span>
                    </div>
                </div>
            `;
            list.appendChild(item);
            new QRCode(document.getElementById(`qr-${id}`), { text: `${BASE_URL}?id=${id}`, width: 128, height: 128 });
        });
    });

    window.deleteItem = async id => { if(confirm("Destroy record?")) await deleteDoc(doc(db, "inventory", id)); };

    // HD Tag System (Print-Ready)
    window.generateHDTag = (id, itemName) => {
        const qrCanvas = document.querySelector(`#qr-${id} canvas`);
        const tag = document.createElement('canvas');
        const ctx = tag.getContext('2d');
        const size = 1500; tag.width = size; tag.height = size;

        ctx.fillStyle = "white"; ctx.fillRect(0,0,size,size);
        ctx.fillStyle = "black"; ctx.textAlign = "center";
        
        ctx.font = "bold 70px Inter"; ctx.fillText("PROPERTY OF", size/2, 180);
        ctx.font = "bold 90px Inter"; ctx.fillText("LOGAN WESTLAKE", size/2, 290);
        
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(qrCanvas, (size-900)/2, 380, 900, 900);
        
        ctx.font = "bold 110px Inter"; ctx.fillText(itemName.toUpperCase(), size/2, 1380);
        ctx.strokeStyle = "black"; ctx.lineWidth = 40; ctx.strokeRect(20,20,size-40,size-40);

        document.getElementById('final-label-img').src = tag.toDataURL();
        document.getElementById('save-modal').style.display = 'flex';
    };

    // Mobile Scanner
    let videoStream = null;
    window.startScanner = () => {
        document.getElementById('scanner-overlay').style.display = 'block';
        navigator.mediaDevices.getUserMedia({video: {facingMode:"environment"}}).then(stream => {
            videoStream = stream;
            const v = document.getElementById('video-preview');
            v.srcObject = stream; v.play();
            const tick = () => {
                if(v.readyState === v.HAVE_ENOUGH_DATA) {
                    const c = document.createElement('canvas');
                    c.width = v.videoWidth; c.height = v.videoHeight;
                    const ctx = c.getContext('2d');
                    ctx.drawImage(v,0,0);
                    const code = jsQR(ctx.getImageData(0,0,c.width,c.height).data, c.width, c.height);
                    if(code) { window.location.href = code.data; stopScanner(); return; }
                }
                if(videoStream) requestAnimationFrame(tick);
            };
            tick();
        });
    };
    window.stopScanner = () => {
        if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
        document.getElementById('scanner-overlay').style.display = 'none';
    };
</script>

</body>
</html>
