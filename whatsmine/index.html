<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>whats mine. | v1.3.5</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        :root {
            --bg: #000000;
            --panel: #0a0a0a;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #ffffff;
            --text-main: #efefef;
            --text-dim: #666;
            --success: #00ff88;
            --danger: #ff453a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 20% 20%, #111 0%, transparent 40%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100dvh;
            padding: env(safe-area-inset-top) 20px calc(env(safe-area-inset-bottom) + 20px) 20px;
        }

        .app-container { 
            width: 100%; 
            max-width: 1100px; 
            display: flex; 
            flex-direction: column; 
            gap: 30px; 
            padding-top: 20px;
        }

        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border);
        }
        
        .brand h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -1.5px; margin: 0; cursor: pointer; }
        .v-tag { font-family: monospace; font-size: 0.6rem; color: var(--text-dim); letter-spacing: 1px; }

        /* HYBRID FLEX LAYOUT */
        .main-layout { 
            display: flex; 
            flex-direction: column; 
            gap: 30px; 
        }

        @media (min-width: 900px) {
            .main-layout { 
                flex-direction: row; 
                align-items: flex-start; 
            }
            aside { width: 340px; position: sticky; top: 20px; }
            main { flex: 1; }
        }

        .card { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            padding: 24px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }

        .section-title { 
            font-size: 0.7rem; 
            font-weight: 800; 
            color: var(--text-dim); 
            text-transform: uppercase; 
            margin-bottom: 20px; 
            display: block; 
            letter-spacing: 1.5px;
        }

        input, textarea { 
            width: 100%; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 15px; 
            color: white; 
            font-size: 16px; 
            margin-bottom: 15px; 
            outline: none;
            transition: 0.2s;
        }
        input:focus { border-color: var(--text-dim); background: rgba(255,255,255,0.06); }

        .btn { 
            width: 100%; 
            padding: 16px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px;
            font-size: 0.9rem;
        }
        .btn-primary { background: white; color: black; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: var(--glass); color: white; border: 1px solid var(--border); }

        /* VAULT ITEMS */
        .vault-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1200px) { .vault-grid { grid-template-columns: 1fr 1fr; } }

        .entry { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            overflow: hidden; 
            transition: 0.3s;
        }
        .entry:hover { border-color: #333; }

        .entry-header { padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .entry-img { width: 100%; height: 250px; object-fit: cover; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); background: #050505; }
        
        .qr-action-area { 
            padding: 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            background: linear-gradient(to right, rgba(255,255,255,0.02), transparent);
            cursor: pointer;
        }
        .qr-thumb { background: white; padding: 5px; border-radius: 8px; flex-shrink: 0; }
        .qr-thumb canvas { width: 70px !important; height: 70px !important; }

        /* MODALS */
        #detail-view, #save-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; 
            background: rgba(0,0,0,0.95); z-index: 9999; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            padding: 20px; backdrop-filter: blur(20px);
        }
        #final-img { width: 100%; max-width: 500px; border-radius: 12px; border: 1px solid white; margin-bottom: 20px; }

        #scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: black; z-index: 10000; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="save-modal" onclick="if(event.target==this) this.style.display='none'">
    <span class="section-title" style="color:white;">Asset Tag Generated</span>
    <img id="final-img">
    <button class="btn btn-secondary" style="width:auto; padding: 12px 30px;">Close Preview</button>
</div>

<div id="detail-view">
    <div class="card" id="detail-content" style="max-width: 450px; width: 100%; border-color: var(--success);"></div>
</div>

<div id="scanner-overlay">
    <video id="video-preview" playsinline></video>
    <button class="btn btn-secondary" style="position:absolute; bottom:40px; width:80%; left:10%;" onclick="stopScanner()">Cancel Scan</button>
</div>

<div class="app-container">
    <header>
        <div class="brand">
            <h1 onclick="location.href='https://lsp-code.github.io/lw/whatsmine/'">whats mine.</h1>
            <div class="v-tag">STABLE_CORE_v1.3.5</div>
        </div>
        <div style="color: var(--success); font-size: 0.6rem; font-weight: 900; letter-spacing: 1px;">UPLINK_LIVE</div>
    </header>

    <div class="main-layout">
        <aside>
            <div class="card">
                <span class="section-title">Record New Asset</span>
                <input type="text" id="itemName" placeholder="Object Identifier" autocomplete="off">
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" id="uploadBtn">
                        Attach Visual
                    </button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none">
                </div>
                <img id="imgPrev" style="width:100%; border-radius:10px; margin-bottom:15px; display:none; border: 1px solid var(--border);">
                <textarea id="itemDesc" rows="3" placeholder="Contextual notes or serials..."></textarea>
                <button class="btn btn-primary" id="saveBtn">Commit to Vault</button>
                <button class="btn btn-secondary" onclick="startScanner()" style="margin-top:10px; border-color: var(--success); color: var(--success);">Trigger Scanner</button>
            </div>
        </aside>

        <main>
            <span class="section-title">Live Vault Feed</span>
            <div id="vaultList" class="vault-grid">
                </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const IMGBB_KEY = "d930d102762e2539450d6d7afceb9811";
    const firebaseConfig = {
        apiKey: "AIzaSyDn3fqrdVcRnvkiX7t6TPJWrngXSrM_1p4",
        authDomain: "my-a-ab8f3.firebaseapp.com",
        projectId: "my-a-ab8f3",
        storageBucket: "my-a-ab8f3.firebasestorage.app",
        messagingSenderId: "65984042323",
        appId: "1:65984042323:web:f4a5463bd4cc220d2c3da6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const col = collection(db, "inventory");
    const BASE = "https://lsp-code.github.io/lw/whatsmine/";

    // Deep Link Logic
    window.addEventListener('DOMContentLoaded', async () => {
        const id = new URLSearchParams(window.location.search).get('id');
        if (id) {
            const snap = await getDoc(doc(db, "inventory", id));
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById('detail-content').innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <span style="background:var(--success); color:black; padding:3px 8px; font-size:0.6rem; font-weight:900; border-radius:4px;">VERIFIED ASSET</span>
                        <span style="cursor:pointer;" onclick="location.href='${BASE}'">âœ•</span>
                    </div>
                    <p style="color:var(--text-dim); font-size:0.7rem; margin:0; font-weight:700;">OWNER</p>
                    <h2 style="margin:0 0 15px 0; letter-spacing:-1px;">LOGAN WESTLAKE</h2>
                    <h3 style="margin:0 0 10px 0; color:var(--success);">${d.name}</h3>
                    ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">` : ''}
                    <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; font-size:0.9rem; line-height:1.6; border:1px solid var(--border);">${d.desc || 'No further data provided.'}</div>
                    <button class="btn btn-primary" style="margin-top:20px;" onclick="location.href='${BASE}'">Access My Vault</button>
                `;
                document.getElementById('detail-view').style.display = 'flex';
            }
        }
    });

    // Image Preview
    document.getElementById('fileInput').onchange = e => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('imgPrev').src = URL.createObjectURL(file);
            document.getElementById('imgPrev').style.display = 'block';
            document.getElementById('uploadBtn').innerText = "Image Locked";
        }
    };

    // Save Logic
    document.getElementById('saveBtn').onclick = async () => {
        const name = document.getElementById('itemName').value;
        const desc = document.getElementById('itemDesc').value;
        const file = document.getElementById('fileInput').files[0];
        if (!name) return alert("Object Identifier Required");

        document.getElementById('saveBtn').innerText = "Syncing...";
        document.getElementById('saveBtn').disabled = true;

        let imageUrl = "";
        if (file) {
            const fd = new FormData(); fd.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const json = await res.json();
            imageUrl = json.data.url;
        }

        await addDoc(col, { name, desc, imageUrl, timestamp: Date.now() });
        location.reload();
    };

    // Live Feed Listener
    onSnapshot(query(col, orderBy("timestamp", "desc")), snap => {
        const list = document.getElementById('vaultList');
        list.innerHTML = '';
        snap.forEach(record => {
            const d = record.data();
            const id = record.id;
            const el = document.createElement('div');
            el.className = 'entry';
            el.innerHTML = `
                <div class="entry-header">
                    <div>
                        <div style="font-weight:800; font-size:1.2rem; letter-spacing:-0.5px;">${d.name}</div>
                        <div style="color:var(--text-dim); font-size:0.7rem; margin-top:4px;">ID: ${id.substring(0,8).toUpperCase()}</div>
                    </div>
                    <span onclick="deleteDoc(doc(db, 'inventory', '${id}'))" style="color:var(--danger); font-size:0.6rem; font-weight:900; cursor:pointer;">EXPUNGE</span>
                </div>
                ${d.imageUrl ? `<img src="${d.imageUrl}" class="entry-img">` : ''}
                <div class="qr-action-area" onclick="generateHDTag('${id}', '${d.name}')">
                    <div class="qr-thumb" id="qr-${id}"></div>
                    <div>
                        <div style="font-weight:700; font-size:0.8rem; color:white;">LOGAN WESTLAKE</div>
                        <div style="color:var(--text-dim); font-size:0.6rem; margin-top:2px;">TAP TO RENDER PRINT LABEL</div>
                    </div>
                </div>
            `;
            list.appendChild(el);
            new QRCode(document.getElementById(`qr-${id}`), { text: `${BASE}?id=${id}`, width: 128, height: 128 });
        });
    });

    // High-Res Tag Generation
    window.generateHDTag = (id, itemName) => {
        const qrCanvas = document.querySelector(`#qr-${id} canvas`);
        const tag = document.createElement('canvas');
        const ctx = tag.getContext('2d');
        const size = 2000;
        tag.width = size; tag.height = size;

        ctx.fillStyle = "white"; ctx.fillRect(0,0,size,size);
        ctx.fillStyle = "black"; ctx.textAlign = "center";
        
        ctx.font = "bold 90px Inter"; ctx.fillText("PROPERTY OF", size/2, 200);
        ctx.font = "bold 110px Inter"; ctx.fillText("LOGAN WESTLAKE", size/2, 330);
        
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(qrCanvas, (size-1100)/2, 420, 1100, 1100);
        
        ctx.font = "bold 130px Inter"; ctx.fillText(itemName.toUpperCase(), size/2, 1720);
        ctx.strokeStyle = "black"; ctx.lineWidth = 50; ctx.strokeRect(25,25,size-50,size-50);

        document.getElementById('final-img').src = tag.toDataURL();
        document.getElementById('save-modal').style.display = 'flex';
    };

    // Camera Logic
    let streamRef = null;
    window.startScanner = () => {
        document.getElementById('scanner-overlay').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            streamRef = s;
            const v = document.getElementById('video-preview');
            v.srcObject = s; v.play();
            const loop = () => {
                if(v.readyState === v.HAVE_ENOUGH_DATA) {
                    const c = document.createElement('canvas');
                    c.width = v.videoWidth; c.height = v.videoHeight;
                    const ctx = c.getContext('2d');
                    ctx.drawImage(v, 0, 0);
                    const code = jsQR(ctx.getImageData(0,0,c.width,c.height).data, c.width, c.height);
                    if(code) { window.location.href = code.data; stopScanner(); return; }
                }
                if(streamRef) requestAnimationFrame(loop);
            };
            loop();
        });
    };
    window.stopScanner = () => {
        if(streamRef) streamRef.getTracks().forEach(t => t.stop());
        streamRef = null;
        document.getElementById('scanner-overlay').style.display = 'none';
    };
</script>

</body>
</html>
